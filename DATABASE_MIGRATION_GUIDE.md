# Database Migration Guide

## New Table: HRMS_SHIFTS

```
CREATE TABLE HRMS_SHIFTS (
  SHIFT_ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  SHIFT_NAME VARCHAR2(100) NOT NULL UNIQUE,
  START_TIME VARCHAR2(5) NOT NULL,
  END_TIME VARCHAR2(5) NOT NULL,
  SHIFT_HOURS NUMBER(5,2),
  DESCRIPTION VARCHAR2(255),
  STATUS VARCHAR2(20) DEFAULT 'ACTIVE' CHECK (STATUS IN ('ACTIVE', 'INACTIVE')),
  OVERTIME_APPLICABLE NUMBER(1) DEFAULT 0 CHECK (OVERTIME_APPLICABLE IN (0, 1)),
  OVERTIME_CAP_HOURS NUMBER(5,2),
  FLEXIBLE_TIME_APPLICABLE NUMBER(1) DEFAULT 0 CHECK (FLEXIBLE_TIME_APPLICABLE IN (0, 1)),
  LATE_COMING_TOLERANCE NUMBER(3) DEFAULT 0 CHECK (LATE_COMING_TOLERANCE BETWEEN 0 AND 60),
  EARLY_GOING_TOLERANCE NUMBER(3) DEFAULT 0 CHECK (EARLY_GOING_TOLERANCE BETWEEN 0 AND 60),
  HAS_BREAK_TIME NUMBER(1) DEFAULT 0 CHECK (HAS_BREAK_TIME IN (0, 1)),
  BREAK_START_TIME VARCHAR2(5),
  BREAK_END_TIME VARCHAR2(5),
  BREAK_HOURS NUMBER(5,2),
  CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

- **SHIFT_ID**: Primary key
- **SHIFT_NAME**: Unique shift name
- **START_TIME**: Shift start time (HH:MM)
- **END_TIME**: Shift end time (HH:MM)
- **SHIFT_HOURS**: Auto-calculated total shift hours (END_TIME - START_TIME; supports overnight)
- **DESCRIPTION**: Optional description
- **STATUS**: 'ACTIVE' or 'INACTIVE'
- **OVERTIME_APPLICABLE**: 1 if overtime is allowed, 0 otherwise
- **OVERTIME_CAP_HOURS**: Max overtime hours allowed (if applicable)
- **FLEXIBLE_TIME_APPLICABLE**: 1 if flexible time is allowed, 0 otherwise
- **LATE_COMING_TOLERANCE**: Max minutes of tolerance for late arrival (0-60)
- **EARLY_GOING_TOLERANCE**: Max minutes of tolerance for early departure (0-60)
- **HAS_BREAK_TIME**: 1 if shift contains a break, 0 otherwise
- **BREAK_START_TIME/BREAK_END_TIME**: Optional break start/end times (HH:MM)
- **BREAK_HOURS**: Auto-calculated break hours (BREAK_END_TIME - BREAK_START_TIME; supports overnight)
- **CREATED_AT, UPDATED_AT**: Timestamps

### Existing deployments (ALTER statements)

```sql
-- Add columns only if they don't already exist
BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE HRMS_SHIFTS ADD (SHIFT_HOURS NUMBER(5,2))';
EXCEPTION WHEN OTHERS THEN IF SQLCODE != -1430 THEN RAISE; END IF; END;
/
BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE HRMS_SHIFTS ADD (HAS_BREAK_TIME NUMBER(1) DEFAULT 0)';
EXCEPTION WHEN OTHERS THEN IF SQLCODE != -1430 THEN RAISE; END IF; END;
/
BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE HRMS_SHIFTS ADD (BREAK_START_TIME VARCHAR2(5))';
EXCEPTION WHEN OTHERS THEN IF SQLCODE != -1430 THEN RAISE; END IF; END;
/
BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE HRMS_SHIFTS ADD (BREAK_END_TIME VARCHAR2(5))';
EXCEPTION WHEN OTHERS THEN IF SQLCODE != -1430 THEN RAISE; END IF; END;
/
BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE HRMS_SHIFTS ADD (BREAK_HOURS NUMBER(5,2))';
EXCEPTION WHEN OTHERS THEN IF SQLCODE != -1430 THEN RAISE; END IF; END;
/
BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE HRMS_SHIFTS ADD CONSTRAINT HRMS_SHIFTS_HAS_BREAK_TIME_CK CHECK (HAS_BREAK_TIME IN (0,1))';
EXCEPTION WHEN OTHERS THEN IF SQLCODE NOT IN (-2260, -955) THEN RAISE; END IF; END;
/
```

- Net `SHIFT_HOURS` is `(END_TIME - START_TIME) - BREAK_HOURS` when `HAS_BREAK_TIME = 1` (overnight supported).

## New Table: HRMS_SQL_SERVER_CONFIGS

```sql
CREATE TABLE HRMS_SQL_SERVER_CONFIGS (
  CONFIG_ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  DB_NAME VARCHAR2(100) NOT NULL,
  USER_ID VARCHAR2(100) NOT NULL,
  PASSWORD VARCHAR2(255) NOT NULL,
  IP_ADDRESS VARCHAR2(45) NOT NULL,
  PORT NUMBER(5) NOT NULL,
  DESCRIPTION VARCHAR2(500),
  IS_ACTIVE NUMBER(1) DEFAULT 1 CHECK (IS_ACTIVE IN (0, 1)),
  CREATED_BY NUMBER NOT NULL,
  CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  -- Foreign Key Constraints
  CONSTRAINT FK_SQL_CONFIG_CREATED_BY FOREIGN KEY (CREATED_BY) REFERENCES HRMS_USERS(USER_ID)
);
```

- **CONFIG_ID**: Primary key
- **DB_NAME**: Database name (letters, numbers, underscores only)
- **USER_ID**: SQL Server user ID
- **PASSWORD**: SQL Server password
- **IP_ADDRESS**: SQL Server IP address
- **PORT**: SQL Server port number (1-65535)
- **DESCRIPTION**: Optional description
- **IS_ACTIVE**: 1 for active configuration, 0 for inactive
- **CREATED_BY**: Foreign key to HRMS_USERS table
- **CREATED_AT, UPDATED_AT**: Timestamps 

## New Table: HRMS_PAYROLL_ATTENDANCE_SUMMARY

```sql
CREATE TABLE HRMS_PAYROLL_ATTENDANCE_SUMMARY (
  SUMMARY_ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  PERIOD_YEAR NUMBER(4) NOT NULL,
  PERIOD_MONTH NUMBER(2) NOT NULL,
  EMPLOYEE_ID NUMBER NOT NULL,
  PRESENT_DAYS NUMBER,
  TOTAL_WORK_HOURS NUMBER(7,2),
  TOTAL_OT_HOURS NUMBER(7,2),
  TOTAL_LATE_MINUTES NUMBER(9),
  TOTAL_SHORT_HOURS NUMBER(7,2),
  CREATED_BY NUMBER,
  CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT UQ_ATT_SUMMARY UNIQUE (PERIOD_YEAR, PERIOD_MONTH, EMPLOYEE_ID),
  CONSTRAINT FK_ATT_SUMMARY_EMP FOREIGN KEY (EMPLOYEE_ID) REFERENCES HRMS_EMPLOYEES(EMPLOYEE_ID),
  CONSTRAINT FK_ATT_SUMMARY_CREATED_BY FOREIGN KEY (CREATED_BY) REFERENCES HRMS_USERS(USER_ID)
);
```

- **Purpose**: Stores per-employee monthly attendance aggregates used during month-end payroll.
- **Short Hours**: Computed as per-day max(0, scheduled minutes - worked minutes) + early leave minutes, aggregated and converted to hours.
- **Notes**: No CLOB columns are used; all text fields are within VARCHAR2 limits.